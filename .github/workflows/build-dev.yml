name: Build Dev

on:
  push:
    branches: [ "develop" ]

jobs:

  build-app:

    strategy:
      matrix:
        os: [ macos-latest, macos-15-intel, ubuntu-latest, windows-latest ]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          package_json_file: frontend/app/package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: frontend/app/.nvmrc

      - name: Setup python (non-macOS)
        if: ${{ !startsWith(matrix.os, 'macos-') }}
        uses: actions/setup-python@v5
        with:
          python-version: 3.11.9

      - name: Setup python (macOS)
        if: ${{ startsWith(matrix.os, 'macos-') }}
        shell: bash
        run: |
          brew install pyenv pyenv-virtualenv

          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          
          # Initialize pyenv and pyenv-virtualenv for the current shell
          eval "$(pyenv init --path)" # Ensures pyenv command is found via shims/bin
          eval "$(pyenv init -)"      # Sets up shims and other integrations
          eval "$(pyenv virtualenv-init -)" # Defines 'pyenv activate' and other venv functions

          pyenv install --skip-existing 3.11.9
          
          # Create virtualenv if it doesn't exist
          if ! pyenv virtualenvs --bare | grep -q "^finanze$"; then
            pyenv virtualenv 3.11.9 finanze
          else
            echo "Virtualenv 'finanze' already exists."
          fi
          
          # Activate for this script block (confirms setup)
          pyenv activate finanze
          
          # Set for pyenv to use this venv in the current directory context
          pyenv local finanze
          
          # Make pyenv and the virtualenv available to subsequent steps in the job
          echo "$PYENV_ROOT/bin" >> $GITHUB_PATH
          echo "$PYENV_ROOT/shims" >> $GITHUB_PATH
          echo "$PYENV_ROOT/versions/finanze/bin" >> $GITHUB_PATH

      - name: Install CD, packaging & runtime deps
        shell: bash
        run: |
          pip install -r requirements-packaging.txt -r requirements.txt -r requirements-cd.txt

      - name: Setup virtual env (non-Windows)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        shell: bash
        run: |
          python3 -m venv $HOME/venv
          echo "$HOME/venv/bin" >> $GITHUB_PATH

      - name: Compute Dev Version
        id: dev_version
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v bump-my-version &> /dev/null; then
            echo "bump-my-version not found after installation." >&2
            exit 1
          fi
          git fetch --tags --quiet || true
          BASE_VERSION=$(bump-my-version show current_version || echo "0.0.0")
          if [[ $BASE_VERSION =~ ^v ]]; then
            TAG_BASE="$BASE_VERSION"
            BASE_NO_V=${BASE_VERSION#v}
          else
            TAG_BASE="v$BASE_VERSION"
            BASE_NO_V="$BASE_VERSION"
          fi
          LAST_TAG=$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COUNT=$(git rev-list ${LAST_TAG}..HEAD --count)
          else
            COUNT=$(git rev-list HEAD --count)
          fi
          SHORT_SHA=$(git rev-parse --short HEAD)
          DEV_VERSION="${BASE_NO_V}-dev${COUNT}-${SHORT_SHA}"
          echo "Computed dev version: $DEV_VERSION (base: $BASE_NO_V)"
          echo "dev_version=$DEV_VERSION" >> "$GITHUB_OUTPUT"

      - name: Hack bumpversion config with dev version
        if: ${{ steps.dev_version.outputs.dev_version != '' }}
        env:
          DEV_VERSION: ${{ steps.dev_version.outputs.dev_version }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Injecting DEV_VERSION into .bumpversion.toml (hack)"
          cp .bumpversion.toml .bumpversion.toml.bak
          python3 - <<'PY'
          import os, pathlib, re
          DEV=os.environ['DEV_VERSION']
          path=pathlib.Path('.bumpversion.toml')
          text=path.read_text()
          # Replace all occurrences of {new_version} (with braces) by the actual dev version string
          new_text=text.replace('{new_version}', DEV)
          path.write_text(new_text)
          print('Replaced {new_version} placeholders with', DEV)
          # Show resulting lines referencing replace patterns
          for line in new_text.splitlines():
              if 'replace =' in line:
                  print('CONFIG:', line)
          PY
          echo "Diff preview (first 30 lines):"
          head -n 30 .bumpversion.toml

      - name: Replace project versions with dev version (ephemeral)
        if: ${{ steps.dev_version.outputs.dev_version != '' }}
        env:
          DEV_VERSION: ${{ steps.dev_version.outputs.dev_version }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Running bump-my-version replace using injected config"
          bump-my-version replace --allow-dirty || { echo "bump-my-version replace failed" >&2; exit 1; }
          echo "Replacement complete. Showing updated versions:"
          grep -E 'version =|"version":' pyproject.toml frontend/app/package.json || true

      - name: Package
        env:
          FINANZE_DEV_VERSION: ${{ steps.dev_version.outputs.dev_version }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Using dev version for artifact naming only: $FINANZE_DEV_VERSION"
          python3 package.py --target full

      - name: Write Dev Version File
        if: ${{ steps.dev_version.outputs.dev_version != '' }}
        shell: bash
        run: |
          echo "${{ steps.dev_version.outputs.dev_version }}" > DEV_VERSION
          mkdir -p dist
          cp DEV_VERSION dist/DEV_VERSION

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finanze-${{ steps.dev_version.outputs.dev_version }}-${{ matrix.os }}
          path: dist/

  build-docker:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install CD deps
        shell: bash
        run: |
          pip install -r requirements-cd.txt

      - name: Compute Dev Version
        id: dev_version
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --quiet || true
          BASE_VERSION=$(bump-my-version show current_version || echo "0.0.0")
          if [[ $BASE_VERSION =~ ^v ]]; then
            TAG_BASE="$BASE_VERSION"
            BASE_NO_V=${BASE_VERSION#v}
          else
            TAG_BASE="v$BASE_VERSION"
            BASE_NO_V="$BASE_VERSION"
          fi
          LAST_TAG=$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COUNT=$(git rev-list ${LAST_TAG}..HEAD --count)
          else
            COUNT=$(git rev-list HEAD --count)
          fi
            SHORT_SHA=$(git rev-parse --short HEAD)
          DEV_VERSION="${BASE_NO_V}-dev${COUNT}-${SHORT_SHA}"
          echo "Computed dev version for docker: $DEV_VERSION (base: $BASE_NO_V)"
          echo "dev_version=$DEV_VERSION" >> "$GITHUB_OUTPUT"

      - name: Hack bumpversion config with dev version
        if: ${{ steps.dev_version.outputs.dev_version != '' }}
        env:
          DEV_VERSION: ${{ steps.dev_version.outputs.dev_version }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Injecting DEV_VERSION into .bumpversion.toml (hack)"
          cp .bumpversion.toml .bumpversion.toml.bak
          python3 - <<'PY'
          import os, pathlib, re
          DEV=os.environ['DEV_VERSION']
          path=pathlib.Path('.bumpversion.toml')
          text=path.read_text()
          # Replace all occurrences of {new_version} (with braces) by the actual dev version string
          new_text=text.replace('{new_version}', DEV)
          path.write_text(new_text)
          print('Replaced {new_version} placeholders with', DEV)
          # Show resulting lines referencing replace patterns
          for line in new_text.splitlines():
              if 'replace =' in line:
                  print('CONFIG:', line)
          PY
          echo "Diff preview (first 30 lines):"
          head -n 30 .bumpversion.toml

      - name: Replace project versions with dev version (ephemeral)
        if: ${{ steps.dev_version.outputs.dev_version != '' }}
        env:
          DEV_VERSION: ${{ steps.dev_version.outputs.dev_version }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Running bump-my-version replace using injected config"
          bump-my-version replace --allow-dirty || { echo "bump-my-version replace failed" >&2; exit 1; }
          echo "Replacement complete. Showing updated versions:"
          grep -E 'version =|"version":' pyproject.toml frontend/app/package.json || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Publish dev frontend image
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: marcosav/finanze-frontend
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          default_branch: develop
          workdir: frontend
          platforms: linux/amd64,linux/arm64/v8
          tags: dev

      - name: Publish dev-selenium image
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: marcosav/finanze
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          default_branch: develop
          platforms: linux/amd64,linux/arm64/v8
          buildargs: SELENIUM_SUPPORT=true
          tags: dev-selenium

      - name: Publish dev-no-selenium image
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: marcosav/finanze
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          default_branch: develop
          platforms: linux/amd64,linux/arm64/v8
          buildargs: SELENIUM_SUPPORT=false
          tags: dev-no-selenium
